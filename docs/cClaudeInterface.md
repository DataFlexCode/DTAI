# cClaudeInterface Class Documentation

CAUTION: This document was generated by an AI and has only gone under cursory review. Consult the source if anything here doesn't work or sound right!

## Overview

The `cClaudeInterface` class provides a DataFlex interface to Anthropic's Claude AI API. It is part of the DTAI (Datatech AI Library) and inherits from `cAIInterface`, which in turn inherits from `cdtJsonHttpTransfer` and includes the `cMarkdown_mixin`.

This class handles communication with Claude AI models, including text prompts and file attachments (images, PDFs, and text files), and provides methods for making API requests and retrieving model information.

## Class Hierarchy

```
cdtJsonHttpTransfer
├── cAIInterface
    ├── cClaudeInterface
        ├── cClaudeInterface_beta
```

## Dependencies

- `cAIResponseTranslator.pkg` - Response translation functionality
- Inherits from `cAIInterface` (defined in `ai.pkg`)
- Uses global `ghoEnvironment` for environment variables

## Properties

### Class Properties
- **`psHost`** (String): API endpoint host  
  Default: `"api.anthropic.com"`

- **`psApiKey`** (String): Claude API key  
  Retrieved from environment variable `claude-api-key` via `ghoEnvironment`

- **`psAnthropicVersion`** (String): API version  
  Default: `"2023-06-01"`

- **`psModelId`** (String): Claude model identifier  
  Default: `"claude-sonnet-4-20250514"`

- **`psDefaultModelID`** (String): Alternative default model ID  
  Default: `''` (empty string)

- **`piMaxTokens`** (Integer): Maximum response tokens  
  Default: `1024`

- **`pbEnableFilesApi`** (Boolean): Enable Files API support  
  Default: `False`

**NOTE:** File support is implemented in the subclass `cClaudeInterface_beta`. Setting `pbEnableFilesApi` to `True` in this class will only add the appropriate header but won't provide full file functionality.

## Embedded Objects

The class contains two embedded objects:

- **`oClaudeRequest`** (cClaudeRequest): Handles request JSON construction
- **`oClaudeTranslator`** (cClaudeTranslator): Translates Claude responses to unified format

## Global Object

A global instance `ghoClaudeAI` is automatically created when using `claudeai.pkg` and can be used throughout your application.

## Methods

### Public Methods

#### `AddStandardHeaders String sContentType`
Adds required HTTP headers for Claude API requests.

**Parameters:**
- `sContentType` (optional): Content type header value (defaults to "application/json" if no arguments provided)

**Headers Added:**
- `Content-Type`: application/json (or specified type)
- `x-api-key`: Your Claude API key
- `anthropic-version`: API version
- `anthropic-beta`: files-api-2025-04-14 (if Files API enabled)

**Implementation Notes:**
- Sets `pbClearHeaders` to `False`
- Clears existing headers before adding new ones
- Uses `num_arguments` to determine if content type was provided

#### `MakeRequestJSON Handle hoRequest Returns Handle`
Sends a JSON request to Claude and returns the response as a JSON handle.

**Parameters:**
- `hoRequest`: Handle to JSON request object

**Returns:**
- Handle to JSON response object
- Returns `0` if request fails

**Error Handling:**
- Displays error messages for transfer failures using `UserError`
- Removes null members from response for cleaner processing
- Checks for API errors in response and displays them via `Stop_Box`
- Destroys response handle if error detected

**Implementation:**
- Uses `httpPostJson` to send request to `v1/messages` endpoint
- Calls `AddStandardHeaders` automatically
- Parses error responses and extracts error type and message

#### `ModelList() Returns tAIModel[]`
Retrieves available Claude models from the API.

**Returns:**
- Array of `tAIModel` structures containing:
  - `id`: Model identifier
  - `display_name`: Human-readable model name
  - `created_at`: Model creation timestamp
  - `type`: Model type

**Implementation:**
- Uses `HttpGetJson` to call `v1/models` endpoint
- Converts Claude model list to unified `tAIModel` format
- Automatically destroys the JSON response handle

#### `CreateRequest String sPrompt [tAIAttachment[] Attachments] Returns Handle`
Creates a Claude API request with text prompt and optional attachments.

**Parameters:**
- `sPrompt`: Text prompt to send to Claude
- `Attachments` (optional): Array of file attachments

**Returns:**
- Handle to JSON request object ready for sending

**Implementation:**
- Delegates to `oClaudeRequest.CreateClaudeApiRequest`
- Handles both single argument (prompt only) and two argument (prompt + attachments) cases
- Uses empty `tClaudeAttachment[]` array when no attachments provided

#### `MakeRequest Handle hoRequest Returns tAIResponse`
**NEW METHOD** - Sends a request and returns a unified response structure.

**Parameters:**
- `hoRequest`: Handle to JSON request object

**Returns:**
- `tAIResponse` structure in unified format

**Implementation:**
- Calls `MakeRequestJSON` internally
- Converts Claude-specific response to unified format using `oClaudeTranslator`
- Returns structured data instead of raw JSON handle

**Usage:**
This method provides a higher-level interface compared to `MakeRequestJSON`, returning structured data that's consistent across different AI providers.

## Data Structures

### tAIAttachment
Used for file attachments:
```dataFlex
Struct tAIAttachment
    UChar[] uBase64File    // Base64 encoded file content
    String sMimeType       // MIME type (e.g., "image/png", "application/pdf")
    String sFileID         // File ID (for Files API)
End_Struct
```

### tAIResponse (Unified Response Structure)
**NEW** - Unified response structure returned by `MakeRequest` method:
```dataFlex
Struct tAIResponse
    // Note: Exact structure depends on cAIResponseTranslator implementation
    // This provides a consistent interface across different AI providers
    String provider        // AI provider identifier
    String model          // Model used
    String[] content      // Response content array
    // Additional unified fields...
End_Struct
```

### tClaudeResponse (Claude-Specific Response)
Response structure from Claude API (used with `MakeRequestJSON`):
```dataFlex
Struct tClaudeResponse
    String id                           // Response ID
    String type                         // Response type
    String role                         // Response role
    String model                        // Model used
    tClaudeResponseContent[] content    // Response content array
    String stop_reason                  // Why generation stopped
    String stop_sequence                // Stop sequence used
    tClaudeResponseUsage usage          // Token usage information
End_Struct
```

### tClaudeResponseContent
Individual content item in Claude response:
```dataFlex
Struct tClaudeResponseContent
    String type    // Content type ("text")
    String text    // Actual response text
End_Struct
```

### tClaudeResponseUsage
Token usage information from Claude:
```dataFlex
Struct tClaudeResponseUsage
    Integer input_tokens                    // Input tokens consumed
    Integer cache_creation_input_tokens     // Cache creation tokens
    Integer cache_read_input_tokens         // Cache read tokens
    Integer output_tokens                   // Output tokens generated
    String service_tier                     // Service tier used
End_Struct
```

## Usage Examples

### Basic Text Prompt (Using MakeRequest - Recommended)

```dataFlex
Procedure AskSimpleQuestion
    String sPrompt sResponse
    Handle hoRequest
    tAIResponse Response
    
    Move "What is the capital of France?" to sPrompt
    
    // Create request
    Get CreateRequest of ghoClaudeAI sPrompt to hoRequest
    
    // Send request and get unified response
    Get MakeRequest of ghoClaudeAI hoRequest to Response
    
    // Extract text response
    If (SizeOfArray(Response.content) > 0) Begin
        Move Response.content[0].text to sResponse
        Showln sResponse
    End
    
    Send Destroy of hoRequest
End_Procedure
```

### Basic Text Prompt (Using MakeRequestJSON - Lower Level)

```dataFlex
Procedure AskSimpleQuestionLowLevel
    String sPrompt sResponse
    Handle hoRequest hoResponse
    tClaudeResponse Response
    
    Move "What is the capital of France?" to sPrompt
    
    // Create request
    Get CreateRequest of ghoClaudeAI sPrompt to hoRequest
    
    // Send request
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse) Begin
        // Convert response to struct
        Set pbRequireAllMembers of hoResponse to False
        Get JsonToDataType of hoResponse to Response
        
        // Extract text response
        If (SizeOfArray(Response.content) > 0) Begin
            Move Response.content[0].text to sResponse
            Showln sResponse
        End
        
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
End_Procedure
```

### Advanced Example with Attachments and Markdown Conversion

```dataFlex
Procedure AskClaude
    String sPrompt sMarkdown sHtml
    tClaudeResponse Response
    tAIAttachment[] Attachments
    Handle hoRequest hoResponse
    UChar[] auRequest
    Integer iArgSize
    
    Get_Argument_Size to iArgSize
    Set_Argument_Size (1024*1024)             
    
    Get Value of oAskClaude to sPrompt
    Get TicketToMarkdown of Phone_DD to sMarkdown        
    Move (sPrompt + CR_LF + sMarkdown) to sPrompt
    Get TicketAttachments to Attachments
    
    // Create request with attachments
    Get CreateRequest of ghoClaudeAI sPrompt Attachments to hoRequest

    Set peWhiteSpace of hoRequest to jpWhitespace_Pretty
    Get StringifyUtf8 of hoRequest to auRequest
    
    // Optional: Debug output to clipboard
    Direct_Output "CLIPBOARD:"
    Writeln auRequest
    Close_Output
    
    // Send request
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse) Begin
        Set pbRequireAllMembers of hoResponse to False
        Get JsonToDataType of hoResponse to Response
        
        If (SizeOfArray(Response.content) > 0) Begin
            // Convert markdown response to HTML
            Get Markdown2Html of ghoClaudeAI Response.content[0].text to sHtml
        End
        
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
    Set_Argument_Size iArgSize
End_Procedure
```

### Getting Available Models

```dataFlex
Procedure ShowAvailableModels
    tAIModel[] Models
    Integer i iCount
    
    Get ModelList of ghoClaudeAI to Models
    Move (SizeOfArray(Models) - 1) to iCount
    
    For i from 0 to iCount
        Showln ("Model: " + Models[i].id + " - " + Models[i].display_name)
    Loop
End_Procedure
```

### Preparing File Attachments

```dataFlex
Procedure PrepareImageAttachment tAIAttachment[] ByRef Attachments String sFilePath
    UChar[] uFileData uBase64Data
    Integer iAttachmentIndex
    
    // Read image file
    Direct_Input channel Default_File_Channel sFilePath
    Read_Block channel Default_File_Channel uFileData 0
    Close_Input channel Default_File_Channel
    
    // Convert to base64
    Get StringToBase64 (UCharArrayToString(uFileData)) to uBase64Data
    
    // Add to attachments array
    Move (SizeOfArray(Attachments)) to iAttachmentIndex
    Move (StringToUCharArray(UCharArrayToString(uBase64Data))) to Attachments[iAttachmentIndex].uBase64File
    Move "image/png" to Attachments[iAttachmentIndex].sMimeType
    Move "" to Attachments[iAttachmentIndex].sFileID
End_Procedure
```

## Environment Setup

### API Key Configuration

The class retrieves the Claude API key from the global `ghoEnvironment` object using the key `'claude-api-key'`.

**Setup Options:**
1. Set the environment variable `claude-api-key` to your API key
2. Add a line `claude-api-key={your key}` to your `{program}.env` file (in the Programs folder)
3. Use the `cEnvironment` class to set the key programmatically:

```dataFlex
// Set API key programmatically
Send SetEnvironmentVariable of ghoEnvironment "claude-api-key" "your-api-key-here"
```

**Important:** The `ghoEnvironment` global object must be available before creating the `cClaudeInterface` instance. This is automatically handled when using the provided package structure. 

### Model Configuration

You can customize the model and parameters:

```dataFlex
// Change model
Set psModelId of ghoClaudeAI to "claude-3-haiku-20240307"

// Increase token limit
Set piMaxTokens of ghoClaudeAI to 4096

// Enable Files API
Set pbEnableFilesApi of ghoClaudeAI to True
```

## Supported File Types

The class supports various file attachment types:

### Images
- **MIME Types**: `image/png`, `image/jpeg`, `image/gif`, `image/webp`
- **Processing**: Sent as base64-encoded image content

### Documents
- **MIME Types**: `application/pdf`
- **Processing**: Sent as base64-encoded document content

### Text Files
- **MIME Types**: `text/plain`, `text/markdown`, `text/csv`, etc.
- **Processing**: Sent as plain text content

## Error Handling

The class provides comprehensive error handling:

### Transfer Errors
- Network connectivity issues
- SSL certificate problems
- Timeout errors

### API Errors
- Invalid API key
- Rate limiting
- Model availability
- Request validation errors

### Example Error Handling

```dataFlex
Procedure SafeClaudeRequest
    Handle hoRequest hoResponse
    String sPrompt
    Boolean bSuccess
    
    Move "Your prompt here" to sPrompt
    Move True to bSuccess
    
    Get CreateRequest of ghoClaudeAI sPrompt to hoRequest
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse = 0) Begin
        Move False to bSuccess
        Showln "Failed to get response from Claude"
    End
    
    If (bSuccess) Begin
        // Process response
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
End_Procedure
```

## Best Practices

### Memory Management
- Always destroy JSON request and response handles
- Use appropriate argument size for large requests
- Clear attachments after use

### Performance
- Reuse the global `ghoClaudeAI` object
- Cache model lists when possible
- Use appropriate token limits

### Security
- Store API keys securely using environment variables
- Validate file attachments before encoding
- Sanitize user input in prompts

## Related Classes

- **`cClaudeRequest`**: Handles request JSON construction (embedded as `oClaudeRequest`)
- **`cClaudeTranslator`**: Translates Claude responses to unified format (embedded as `oClaudeTranslator`)
- **`cAIInterface`**: Base class for AI interfaces (provides HTTP transfer and markdown functionality)
- **`cAIResponseTranslator`**: Base class for response translation functionality
- **`cEnvironment`**: Environment variable management (accessed via global `ghoEnvironment`)
- **`cClaudeInterface_beta`**: Extended subclass with full file support capabilities

### Key Dependencies

The class depends on several components being available:
1. **Global Environment**: `ghoEnvironment` must be initialized for API key retrieval
2. **HTTP Transfer**: Inherits HTTP/HTTPS capabilities from `cAIInterface`
3. **JSON Processing**: Uses DataFlex JSON objects for request/response handling
4. **Response Translation**: Uses `cAIResponseTranslator` for consistent response formats

## Version Information

- **Library Version**: DTAI 0.1
- **Claude API Version**: 2023-06-01
- **Default Model**: claude-sonnet-4-20250514

## See Also

- [cMultipartFormdataTransfer Documentation](cMultipartFormdataTransfer.md)
- [DTAI Library Overview](../README.md)
- [Claude API Documentation](https://docs.anthropic.com/claude/reference/)

