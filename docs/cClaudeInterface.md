# cClaudeInterface Class Documentation

CAUTION:  this document was generated by an AI and has only gone under cursory review.  Consult the source if anything here doesn't work or sound right!

## Overview

The `cClaudeInterface` class provides a DataFlex interface to Anthropic's Claude AI API. It is part of the DTAI (Datatech AI Library) and inherits from `cAIInterface`, which in turn inherits from `cdtJsonHttpTransfer` and includes the `cMarkdown_mixin`.

This class handles communication with Claude AI models, including text prompts and file attachments (images, PDFs, and text files), and provides methods for making API requests and retrieving model information.

## Class Hierarchy

```
cdtJsonHttpTransfer
├── cAIInterface
    ├── cClaudeInterface
        ├── cClaudeInterface_beta
```

## Dependencies

- `ai.pkg` - Base AI interface
- `claudeai.h` - Claude-specific data structures
- `cClaudeRequest.pkg` - Request builder class
- `cEnvironment.pkg` - Environment variable management
- `cJsonObject.pkg` - JSON handling

## Properties

### Required Properties
- **`psHost`** (String): API endpoint host  
  Default: `"api.anthropic.com"`

- **`psApiKey`** (String): Claude API key  
  Retrieved from environment variable `claude-api-key`

- **`psAnthropicVersion`** (String): API version  
  Default: `"2023-06-01"`

- **`psModelId`** (String): Claude model identifier  
  Default: `"claude-sonnet-4-20250514"`

- **`piMaxTokens`** (Integer): Maximum response tokens  
  Default: `1024`

- **`pbEnableFilesApi`** (Boolean): Enable Files API support  
  Default: `False`

NOTE:  file support is implemented in the subclass cClaudeInterface_beta.  Setting pbEnableFilesApi to true in this class will do nothing

## Global Object

A global instance `ghoClaudeAI` is automatically created and can be used throughout your application:

## Methods

### Public Methods

#### `AddStandardHeaders [String sContentType]`
Adds required HTTP headers for Claude API requests.

**Parameters:**
- `sContentType` (optional): Content type header value (defaults to "application/json")

**Headers Added:**
- `Content-Type`: application/json (or specified type)
- `x-api-key`: Your Claude API key
- `anthropic-version`: API version
- `anthropic-beta`: files-api-2025-04-14 (if Files API enabled)

#### `MakeRequestJSON Handle hoRequest Returns Handle`
Sends a JSON request to Claude and returns the response.

**Parameters:**
- `hoRequest`: Handle to JSON request object

**Returns:**
- Handle to JSON response object
- Returns 0 if request fails

**Error Handling:**
- Displays error messages for transfer failures
- Parses and displays Claude API errors from response

#### `ModelList Returns tAIModel[]`
Retrieves available Claude models.

**Returns:**
- Array of `tAIModel` structures containing:
  - `id`: Model identifier
  - `display_name`: Human-readable model name
  - `created_at`: Model creation timestamp
  - `type`: Model type

#### `CreateRequest String sPrompt [, tAIAttachment[] Attachments] Returns Handle`
Creates a Claude API request with text prompt and optional attachments.

**Parameters:**
- `sPrompt`: Text prompt to send to Claude
- `Attachments` (optional): Array of file attachments

**Returns:**
- Handle to JSON request object ready for sending

## Data Structures

### tAIAttachment
Used for file attachments:
```dataFlex
Struct tAIAttachment
    UChar[] uBase64File    // Base64 encoded file content
    String sMimeType       // MIME type (e.g., "image/png", "application/pdf")
    String sFileID         // File ID (for Files API)
End_Struct
```

### tClaudeResponse
Response structure from Claude:
```dataFlex
Struct tClaudeResponse
    String id                           // Response ID
    String type                         // Response type
    String role                         // Response role
    String model                        // Model used
    tClaudeResponseContent[] content    // Response content array
    String stop_reason                  // Why generation stopped
    String stop_sequence                // Stop sequence used
    tClaudeResponseUsage usage          // Token usage information
End_Struct
```

### tClaudeResponseContent
Individual content item in response:
```dataFlex
Struct tClaudeResponseContent
    String type    // Content type ("text")
    String text    // Actual response text
End_Struct
```

## Usage Examples

### Basic Text Prompt

```dataFlex
Procedure AskSimpleQuestion
    String sPrompt sResponse
    Handle hoRequest hoResponse
    tClaudeResponse Response
    
    Move "What is the capital of France?" to sPrompt
    
    // Create request
    Get CreateRequest of ghoClaudeAI sPrompt to hoRequest
    
    // Send request
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse) Begin
        // Convert response to struct
        Set pbRequireAllMembers of hoResponse to False
        Get JsonToDataType of hoResponse to Response
        
        // Extract text response
        If (SizeOfArray(Response.content) > 0) Begin
            Move Response.content[0].text to sResponse
            Showln sResponse
        End
        
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
End_Procedure
```

### Advanced Example with Attachments and Markdown Conversion

```dataFlex
Procedure AskClaude
    String sPrompt sMarkdown sHtml
    tClaudeResponse Response
    tAIAttachment[] Attachments
    Handle hoRequest hoResponse
    UChar[] auRequest
    Integer iArgSize
    
    Get_Argument_Size to iArgSize
    Set_Argument_Size (1024*1024)             
    
    Get Value of oAskClaude to sPrompt
    Get TicketToMarkdown of Phone_DD to sMarkdown        
    Move (sPrompt + CR_LF + sMarkdown) to sPrompt
    Get TicketAttachments to Attachments
    
    // Create request with attachments
    Get CreateRequest of ghoClaudeAI sPrompt Attachments to hoRequest

    Set peWhiteSpace of hoRequest to jpWhitespace_Pretty
    Get StringifyUtf8 of hoRequest to auRequest
    
    // Optional: Debug output to clipboard
    Direct_Output "CLIPBOARD:"
    Writeln auRequest
    Close_Output
    
    // Send request
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse) Begin
        Set pbRequireAllMembers of hoResponse to False
        Get JsonToDataType of hoResponse to Response
        
        If (SizeOfArray(Response.content) > 0) Begin
            // Convert markdown response to HTML
            Get Markdown2Html of ghoClaudeAI Response.content[0].text to sHtml
        End
        
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
    Set_Argument_Size iArgSize
End_Procedure
```

### Getting Available Models

```dataFlex
Procedure ShowAvailableModels
    tAIModel[] Models
    Integer i iCount
    
    Get ModelList of ghoClaudeAI to Models
    Move (SizeOfArray(Models) - 1) to iCount
    
    For i from 0 to iCount
        Showln ("Model: " + Models[i].id + " - " + Models[i].display_name)
    Loop
End_Procedure
```

### Preparing File Attachments

```dataFlex
Procedure PrepareImageAttachment tAIAttachment[] ByRef Attachments String sFilePath
    UChar[] uFileData uBase64Data
    Integer iAttachmentIndex
    
    // Read image file
    Direct_Input channel Default_File_Channel sFilePath
    Read_Block channel Default_File_Channel uFileData 0
    Close_Input channel Default_File_Channel
    
    // Convert to base64
    Get StringToBase64 (UCharArrayToString(uFileData)) to uBase64Data
    
    // Add to attachments array
    Move (SizeOfArray(Attachments)) to iAttachmentIndex
    Move (StringToUCharArray(UCharArrayToString(uBase64Data))) to Attachments[iAttachmentIndex].uBase64File
    Move "image/png" to Attachments[iAttachmentIndex].sMimeType
    Move "" to Attachments[iAttachmentIndex].sFileID
End_Procedure
```

## Environment Setup

### API Key Configuration

By default, this class will use the ghoEnvironment global object to set the Claude API key.

1. Set the environment variable `claude-api-key` to your API key
2. Add a line `claude-api-key={your key}` to your {program}.env file (in the Programs folder) 

### Model Configuration

You can customize the model and parameters:

```dataFlex
// Change model
Set psModelId of ghoClaudeAI to "claude-3-haiku-20240307"

// Increase token limit
Set piMaxTokens of ghoClaudeAI to 4096

// Enable Files API
Set pbEnableFilesApi of ghoClaudeAI to True
```

## Supported File Types

The class supports various file attachment types:

### Images
- **MIME Types**: `image/png`, `image/jpeg`, `image/gif`, `image/webp`
- **Processing**: Sent as base64-encoded image content

### Documents
- **MIME Types**: `application/pdf`
- **Processing**: Sent as base64-encoded document content

### Text Files
- **MIME Types**: `text/plain`, `text/markdown`, `text/csv`, etc.
- **Processing**: Sent as plain text content

## Error Handling

The class provides comprehensive error handling:

### Transfer Errors
- Network connectivity issues
- SSL certificate problems
- Timeout errors

### API Errors
- Invalid API key
- Rate limiting
- Model availability
- Request validation errors

### Example Error Handling

```dataFlex
Procedure SafeClaudeRequest
    Handle hoRequest hoResponse
    String sPrompt
    Boolean bSuccess
    
    Move "Your prompt here" to sPrompt
    Move True to bSuccess
    
    Get CreateRequest of ghoClaudeAI sPrompt to hoRequest
    Get MakeRequestJSON of ghoClaudeAI hoRequest to hoResponse
    
    If (hoResponse = 0) Begin
        Move False to bSuccess
        Showln "Failed to get response from Claude"
    End
    
    If (bSuccess) Begin
        // Process response
        Send Destroy of hoResponse
    End
    
    Send Destroy of hoRequest
End_Procedure
```

## Best Practices

### Memory Management
- Always destroy JSON request and response handles
- Use appropriate argument size for large requests
- Clear attachments after use

### Performance
- Reuse the global `ghoClaudeAI` object
- Cache model lists when possible
- Use appropriate token limits

### Security
- Store API keys securely using environment variables
- Validate file attachments before encoding
- Sanitize user input in prompts

## Related Classes

- **`cClaudeRequest`**: Handles request JSON construction
- **`cAIInterface`**: Base class for AI interfaces
- **`cEnvironment`**: Environment variable management
- **`cMarkdown_mixin`**: Provides markdown conversion methods

## Version Information

- **Library Version**: DTAI 0.1
- **Claude API Version**: 2023-06-01
- **Default Model**: claude-sonnet-4-20250514

## See Also

- [cMultipartFormdataTransfer Documentation](cMultipartFormdataTransfer.md)
- [DTAI Library Overview](../README.md)
- [Claude API Documentation](https://docs.anthropic.com/claude/reference/)
